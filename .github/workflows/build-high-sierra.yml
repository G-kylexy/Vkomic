name: Build High Sierra (macOS 10.13)

on:
  workflow_dispatch:

# 1. Variable globale pour tout le workflow pour forcer la compatibilité dès le départ
env:
  MACOSX_DEPLOYMENT_TARGET: '10.13'

permissions:
  contents: read

jobs:
  build-high-sierra:
    # 2. Utilisation de macos-latest (M1/M2) - Démarrage instantané
    runs-on: macos-latest
    name: Build macOS x64 (High Sierra compatible)

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: x86_64-apple-darwin

      - name: Download MacOS 10.13 SDK
        run: |
          mkdir -p sdk
          curl -L https://github.com/phracker/MacOSX-SDKs/releases/download/11.3/MacOSX10.13.sdk.tar.xz | tar -xJ -C sdk
          echo "SDKROOT=$GITHUB_WORKSPACE/sdk/MacOSX10.13.sdk" >> $GITHUB_ENV

      - name: Cache Rust
        uses: Swatinem/rust-cache@v2
        with:
          workspaces: src-tauri
          shared-key: x86_64-apple-darwin-highsierra-v2

      - name: Install dependencies
        run: npm ci

      - name: Build Tauri App
        # On force l'utilisation du SDK 10.13 téléchargé et le target Intel
        env:
          MACOSX_DEPLOYMENT_TARGET: '10.13'
          SDKROOT: ${{ env.SDKROOT }}
          RUSTFLAGS: >-
            -C link-arg=-Wl,-weak_framework,Foundation
            -C link-arg=-Wl,-weak_framework,CFNetwork
            -C link-arg=-Wl,-weak_framework,Security
            -C link-arg=-target -C link-arg=x86_64-apple-macos10.13
        run: npm run tauri:build -- --target x86_64-apple-darwin

      - name: Verify Symbols (Pre-release check)
        shell: bash
        run: |
          BINARY="src-tauri/target/x86_64-apple-darwin/release/app"
          if [ -f "$BINARY" ]; then
            echo "Checking symbols for $BINARY..."
            # On vérifie si le symbole problématique est présent et s'il est faible (V/v) ou indéfini (U)
            # S'il est fort, nm affichera S/T/D/etc. 
            # On veut qu'il soit absent ou explicitement marqué comme pouvant être manquant.
            SYMBOLS=$(nm -m "$BINARY" | grep "NSHTTPCookieSameSiteLax" || true)
            echo "Result: $SYMBOLS"
            if echo "$SYMBOLS" | grep -q " (from Foundation)"; then
               if echo "$SYMBOLS" | grep -q "weak"; then
                 echo "✅ Symbol is weakly linked. OK."
               else
                 echo "❌ Symbol is STRONGLY linked. It will crash on High Sierra."
                 # On ne fail pas encore le build ici pour te laisser voir le résultat, 
                 # mais on prévient.
               fi
            else
               echo "✅ Symbol not found in binary. OK."
            fi
          else
            echo "Binary not found at $BINARY"
          fi

      - name: Stage artifacts
        shell: bash
        run: |
          VERSION=$(node -p "require('./package.json').version")
          ARTIFACT_DIR="src-tauri/target/x86_64-apple-darwin/release/bundle"

          mkdir -p final_assets

          find "$ARTIFACT_DIR" -type f \( -name "*.dmg" -o -name "*.app" \) | while read -r filepath; do
            filename=$(basename "$filepath")
            ext=".${filename##*.}"
            newname="vkomic-${VERSION}-mac-x64-highsierra${ext}"
            echo "Staging: $filename as $newname"
            cp "$filepath" "final_assets/$newname"
          done

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: vkomic-mac-x64-highsierra
          path: final_assets/*
          retention-days: 7
